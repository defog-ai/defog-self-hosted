# builds image for the agents backend
FROM python:3.10

WORKDIR agents-python-server

ARG GOOGLE_APPLICATION_CREDENTIALS_PATH

# copy google creds
COPY $GOOGLE_APPLICATION_CREDENTIALS_PATH /cloud-storage-creds.json

# need cmake for scikit
RUN apt-get update && apt-get install -y python3-pip cmake

COPY ./agents-backend/agents/requirements.txt ./requirements.txt
# install requirements
RUN pip install -r requirements.txt

# expose python server port
EXPOSE 1235

ENV GOOGLE_APPLICATION_CREDENTIALS=/cloud-storage-creds.json

COPY ./agents-backend/agents/ ./

# create empty report assets dirs
RUN mkdir -p /agents-python-server/report-assets
RUN mkdir -p /agents-python-server/report-assets/boxplots 
RUN mkdir -p /agents-python-server/report-assets/datasets 
RUN mkdir -p /agents-python-server/report-assets/heatmaps 
RUN mkdir -p /agents-python-server/report-assets/kaplan-meier-plots 
RUN mkdir -p /agents-python-server/report-assets/linechart 
RUN mkdir -p /agents-python-server/report-assets/linecharts

CMD python3 create_admin_user.py && python3 -m hypercorn main:app -b 0.0.0.0:1235
