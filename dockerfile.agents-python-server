# builds image for the agents backend
FROM python:3.10

WORKDIR agents-python-server

ARG GOOGLE_APPLICATION_CREDENTIALS_PATH

# copy google creds
COPY $GOOGLE_APPLICATION_CREDENTIALS_PATH /cloud-storage-creds.json

# need cmake for scikit
RUN apt-get update && apt-get install -y python3-pip cmake

COPY ./agents-backend/agents/requirements.txt ./requirements.txt
# install requirements
RUN pip install -r requirements.txt

# expose python server port
EXPOSE 1235

ENV GOOGLE_APPLICATION_CREDENTIALS=/cloud-storage-creds.json

COPY ./agents-backend/agents/agents ./agents
COPY ./agents-backend/agents/__init__.py ./__init__.py
COPY ./agents-backend/agents/.env.yaml ./.env.yaml
COPY ./agents-backend/agents/connection_manager.py ./connection_manager.py
COPY ./agents-backend/agents/db_utils.py ./db_utils.py
COPY ./agents-backend/agents/doc_endpoints.py ./doc_endpoints.py
COPY ./agents-backend/agents/gcs_consumer.py ./gcs_consumer.py
COPY ./agents-backend/agents/gcs_utils.py ./gcs_utils.py
COPY ./agents-backend/agents/main.py ./main.py
COPY ./agents-backend/agents/README.md ./README.md
COPY ./agents-backend/agents/report_data_manager.py ./report_data_manager.py
COPY ./agents-backend/agents/send_email.py ./send_email.py
COPY ./agents-backend/agents/slack_utils.py ./slack_utils.py
COPY ./agents-backend/agents/sync-gcs.py ./sync-gcs.py
COPY ./agents-backend/agents/utils.py ./utils.py

# create empty report assets dirs
RUN mkdir -p /agents-python-server/report-assets
RUN mkdir -p /agents-python-server/report-assets/boxplots 
RUN mkdir -p /agents-python-server/report-assets/datasets 
RUN mkdir -p /agents-python-server/report-assets/heatmaps 
RUN mkdir -p /agents-python-server/report-assets/kaplan-meier-plots 
RUN mkdir -p /agents-python-server/report-assets/linechart 
RUN mkdir -p /agents-python-server/report-assets/linecharts

CMD python3 create_admin_user.py && python3 -m hypercorn main:app -b 0.0.0.0:1235
